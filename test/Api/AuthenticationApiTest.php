<?php
/**
 * AuthenticationApiTest
 * PHP version 8.1
 *
 * @category Class
 * @package  Alfaview\Client
 * @author   OpenAPI Generator team
 * @link     https://openapi-generator.tech
 */

/**
 * alfaview
 *
 * ## General format information * All time fields are returned in RFC3339 format and in UTC if not mentioned otherwise.
 *
 * The version of the OpenAPI document: 2
 * Generated by: https://openapi-generator.tech
 * Generator version: 7.16.0-SNAPSHOT
 */

/**
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Please update the test case below to test the endpoint.
 */

namespace Alfaview\Client\Test\Api;

use Alfaview\Client\Alfaview;

use Alfaview\Client\Model\APICredentials;
use Alfaview\Client\Model\AuthenticateGroupLinkRequestBody;
use Alfaview\Client\Model\GroupLinkCreate;
use Alfaview\Client\Model\GuestAuthInfoRequestData;
use Alfaview\Client\Model\CreateGroupLinksRequestBody;
use Alfaview\Client\Model\RoomCreate;
use PHPUnit\Framework\TestCase;

/**
 * AuthenticationApiTest Class Doc Comment
 *
 * @category Class
 * @package  Alfaview\Client
 * @author   OpenAPI Generator team
 * @link     https://openapi-generator.tech
 */
class AuthenticationApiTest extends TestCase
{
    protected Alfaview $alfaview;

    protected APICredentials $credentials;

    /**
     * Setup before running any test cases
     */
    public static function setUpBeforeClass(): void
    {
    }

    /**
     * Setup before running each test case
     */
    public function setUp(): void
    {
        $this->alfaview = new Alfaview();
        $this->alfaview->setHost(getenv('API_HOST'));

        $this->credentials = new APICredentials();
        $this->credentials->setClientId(getenv('API_CLIENT_ID'));
        $this->credentials->setKey(getenv('API_CODE'));
        $this->credentials->setCompanyId(getenv('API_COMPANY_ID'));
    }

    /**
     * Clean up after running each test case
     */
    public function tearDown(): void
    {
        $accessToken = $this->alfaview->authenticationApi->authenticateAPIKey($this->credentials);
        $response = $this->alfaview->roomsApi->listRooms($accessToken->getAccessToken());

        foreach ($response->getData() as $room) {
            if (strpos($room->getDisplayName(), 'created by php-sdk') !== false) {
                $this->alfaview->roomsApi->deleteRoom($room->getId(), $accessToken->getAccessToken());
            }
        }
    }

    /**
     * Clean up after running all test cases
     */
    public static function tearDownAfterClass(): void
    {
    }

    /**
     * Test case for authenticateAPIKey
     *
     * Authenticate via API key.
     *
     */
    public function testAuthenticateAPIKey()
    {
        $accessToken = $this->alfaview->authenticationApi->authenticateAPIKey($this->credentials);

        $this->assertNotEmpty($accessToken->getAccessToken());
    }

    /**
     * Test case for authenticateGuest
     *
     * Authenticate a guest.
     *
     */
    public function testAuthenticateGuest()
    {
        $accessToken = $this->alfaview->authenticationApi->authenticateAPIKey($this->credentials);

        $roomCreate = new RoomCreate();
        $roomCreate->setDisplayName('room created by php-sdk V2');
        $roomCreate->setType(RoomCreate::TYPE_ROOM);
        $roomCreate->setWaitingRoomEnabled(false);

        $room = $this->alfaview->roomsApi->createRoom($roomCreate, $accessToken->getAccessToken());
        $roomId = $room->getId();
        $this->assertNotEmpty($roomId);

        $permissionGroups = $this->alfaview->roomsApi->listPermissionGroups($accessToken->getAccessToken());
        $participantPermissionGroupId = null;
        foreach ($permissionGroups as $permissionGroup) {
            if ($permissionGroup->getName() === 'Participant') {
                $participantPermissionGroupId = $permissionGroup->getId();
            }
        }

        $groupLink = new GroupLinkCreate();
        $groupLink->setDescription('PHP SDK Group Link');
        $groupLink->setDialInAllowed(false);
        $groupLink->setPermissionGroupId($participantPermissionGroupId);
        $groupLink->setValidUntil(new \DateTime('next week today'));

        $groupLinksRequest = new CreateGroupLinksRequestBody();
        $groupLinksRequest->setCreate([$groupLink]);

        $groupLink = $this->alfaview->guestsApi->createGroupLink($roomId, $groupLinksRequest, $accessToken->getAccessToken());

        $this->assertNotEmpty($groupLink);

        $groupLink = $this->alfaview->guestsApi->getGroupLink($groupLink[0]->getId(), $accessToken->getAccessToken());

        $groupLinkData = new AuthenticateGroupLinkRequestBody();
        $groupLinkData->setDisplayName('John Doe');
        $groupLinkData->setCompanyId(getenv('API_COMPANY_ID'));
        $groupLinkData->setRoomId($roomId);
        $groupLinkData->setExternalId(md5('external_id'));
        $groupLinkData->setAccessKey($groupLink->getAccessKey());

        $groupLinkAuthResponse = $this->alfaview->authenticationApi->authenticateGroupLink($groupLinkData);
        $this->assertNotEmpty($groupLinkAuthResponse->getAccessToken());

    }

    /**
     * Test case for authenticateUser
     *
     * Authenticate a user.
     *
     */
    public function testAuthenticateUser()
    {
        // TODO: implement
        self::markTestIncomplete('Not implemented');
    }

    /**
     * Test case for getTokenInfo
     *
     * Get access token information.
     *
     */
    public function testGetTokenInfo()
    {
        $accessToken = $this->alfaview->authenticationApi->authenticateAPIKey($this->credentials);
        $resp = $this->alfaview->authenticationApi->getTokenInfo($accessToken->getAccessToken());
        
        $permissions = $resp->getPermissions();

        $this->assertTrue($resp->getActive());
        $this->assertNotEmpty($permissions->getRoomAdmin());
    }

    /**
     * Test case for inviteUser
     *
     * Invite user.
     *
     */
    public function testInviteUser()
    {
        // TODO: implement
        self::markTestIncomplete('Not implemented');
    }
}
